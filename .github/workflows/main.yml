name: RDP Setup and VirtualBox Installer + OVA Download

on:
  workflow_dispatch:

jobs:
  setup-rdp-and-vm:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Configure Core RDP Settings
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389
          Restart-Service -Name TermService -Force

      - name: Create RDP User
        run: |
          $password = 'Zain.rty123'
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          if (Get-LocalUser -Name "Administrator" -ErrorAction SilentlyContinue) {
              Set-LocalUser -Name "Administrator" -Password $securePass
          } else {
              New-LocalUser -Name "Administrator" -Password $securePass -AccountNeverExpires
          }
          Add-LocalGroupMember -Group "Administrators" -Member "Administrator" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "Administrator" -ErrorAction SilentlyContinue
          echo "RDP_CREDS=$password" >> $env:GITHUB_ENV

      - name: Keep Administrator Session Active
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fResetBroken" -Value 0
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "IdleTimeout" -Value 0
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "MaxIdleTime" -Value 0
          Set-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System' -Name "InactivityTimeoutSecs" -Value 0
          powercfg.exe /change monitor-timeout-ac 0
          powercfg.exe /change standby-timeout-ac 0

      - name: Install Tailscale
        run: |
          $tsUrl = "[https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi](https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi)"
          $installerPath = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i `"$installerPath`" /quiet /norestart" -Wait
          Remove-Item $installerPath -Force

      - name: Establish Tailscale Connection
        run: |
          $authKey = "${{ secrets.TAILSCALE_AUTH_KEY }}"
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$authKey --hostname=gh-runner-$env:GITHUB_RUN_ID
          $tsIP = $null
          $retries = 0
          while (-not $tsIP -and $retries -lt 10) {
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              Start-Sleep -Seconds 5
              $retries++
          }
          if (-not $tsIP) {
              Write-Error "Tailscale IP not assigned. Exiting."
              exit 1
          }
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV

      - name: Verify RDP Accessibility
        run: |
          Write-Host "Tailscale IP: $env:TAILSCALE_IP"
          $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389
          if (-not $testResult.TcpTestSucceeded) {
              Write-Error "TCP connection to RDP port 3389 failed"
              exit 1
          }
          Write-Host "TCP connectivity successful!"

      - name: Download VirtualBox and OVA Directly (No Keys)
        run: |
          $dest = "C:\Users\Administrator\Desktop\Public"
          if (-not (Test-Path $dest)) { New-Item -ItemType Directory -Path $dest | Out-Null }

          Write-Host "Downloading OVA..."
          Invoke-WebRequest `
            -Uri "[https://pub-4e3db5ccea8a4f30ae7d4ee15e71f566.r2.dev/Nadeem.ova](https://pub-4e3db5ccea8a4f30ae7d4ee15e71f566.r2.dev/Nadeem.ova)" `
            -OutFile "$dest\Nadeem.ova" `
            -UseBasicParsing

          Write-Host "Downloading VirtualBox installer..."
          Invoke-WebRequest `
            -Uri "[https://download.virtualbox.org/virtualbox/7.2.4/VirtualBox-7.2.4-170995-Win.exe](https://download.virtualbox.org/virtualbox/7.2.4/VirtualBox-7.2.4-170995-Win.exe)" `
            -OutFile "$dest\VirtualBox-7.2.4-170995-Win.exe" `
            -UseBasicParsing

      - name: Install VirtualBox Silently
        run: |
          $vbInstaller = "C:\Users\Administrator\Desktop\Public\VirtualBox-7.2.4-170995-Win.exe"
          Start-Process -FilePath $vbInstaller -ArgumentList "--silent --msiparams ALLUSERS=2" -Wait
          
          # Verify installation path exists
          if (-not (Test-Path "C:\Program Files\Oracle\VirtualBox\VBoxManage.exe")) {
            throw "VirtualBox installation failed or path not found."
          }

      - name: Import and Start OVA as Administrator
        run: |
          # --- Configuration ---
          $VBoxPath = "C:\Program Files\Oracle\VirtualBox\VBoxManage.exe"
          $OVAFile  = "C:\Users\Administrator\Desktop\Public\Nadeem.ova"
          $VMName   = "NadeemVM"
          $LogPath  = "C:\Windows\Temp\vbox_debug.log"
          
          # --- Credential Setup ---
          # Create credentials for the 'Administrator' user using the password defined in previous steps
          $password = $env:RDP_CREDS
          $secPass  = ConvertTo-SecureString $password -AsPlainText -Force
          $cred     = New-Object System.Management.Automation.PSCredential ("Administrator", $secPass)

          Write-Host "Preparing to execute VBoxManage as user: Administrator"

          # --- Step 1: Import OVA ---
          # We wrap the command in cmd /c to handle redirection (>) which isn't natively passed by Start-Process
          # --vsys 0 --eula accept: Auto-accepts license to prevent hanging
          # --vsys 0 --vmname: Ensures the VM has a predictable name for the start command
          $importArgs = "/c `"$VBoxPath`" import `"$OVAFile`" --vsys 0 --vmname `"$VMName`" --eula accept > $LogPath 2>&1"
          
          Write-Host "Importing OVA... (This may take time)"
          $proc = Start-Process -FilePath "cmd.exe" -ArgumentList $importArgs -Credential $cred -PassThru -Wait -WindowStyle Hidden

          # Output logs for debugging
          if (Test-Path $LogPath) { Get-Content $LogPath }
          if ($proc.ExitCode -ne 0) { 
            Write-Error "Import failed with exit code $($proc.ExitCode)" 
            exit $proc.ExitCode
          }

          # --- Step 2: Enable Nested Virtualization (Optional/Recommended) ---
          # Attempts to pass hardware virtualization features to the guest (required for performance)
          $modArgs = "/c `"$VBoxPath`" modifyvm `"$VMName`" --nested-hw-virt on"
          Start-Process -FilePath "cmd.exe" -ArgumentList $modArgs -Credential $cred -Wait -WindowStyle Hidden

          # --- Step 3: Start VM Headless ---
          # --type headless: Starts the VM in the background of the Administrator session. 
          # It will be visible in the GUI when you log in via RDP.
          $startArgs = "/c `"$VBoxPath`" startvm `"$VMName`" --type headless >> $LogPath 2>&1"
          
          Write-Host "Starting VM..."
          $procStart = Start-Process -FilePath "cmd.exe" -ArgumentList $startArgs -Credential $cred -PassThru -Wait -WindowStyle Hidden
          
          if (Test-Path $LogPath) { Get-Content $LogPath -Tail 20 }
          
          if ($procStart.ExitCode -eq 0) {
            Write-Host "SUCCESS: VM '$VMName' started as Administrator."
          } else {
            Write-Error "VM failed to start. Check logs above."
            exit $procStart.ExitCode
          }

      - name: Maintain RDP Connection
        run: |
          Write-Host "`n=== RDP ACCESS ==="
          Write-Host "Address: $env:TAILSCALE_IP"
          Write-Host "Username: Administrator"
          Write-Host "Password: $env:RDP_CREDS"
          Write-Host "==================`n"
          while ($true) {
              Write-Host " RDP Active - Use Ctrl+C to terminate"
              Start-Sleep -Seconds 300
          }
